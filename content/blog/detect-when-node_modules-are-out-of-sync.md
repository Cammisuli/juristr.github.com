---
type: post
title: Detect when node_modules are out of sync
date: 2020-08-26T14:19 +02:00
lead: Remember those moments when you have those weird issues, and all that was
  needed was a clean node_modules install
url: /blog/2020/08/detect-node_modules-out-of-sync
draft: false
categories:
  - tooling
tags:
  - tooling
comments: true
---
{{<intro>}}
  I'm pretty sure this already happened to you as well. You pull down the latest `main` branch or jump to some feature branch and you start getting weird errors. Until only later you recognize you forgot to execute an `npm install`. Let's look into how we can avoid that.
{{</intro>}}

<!--more-->

{{< postad >}}

Actually, if you're using Webstorm you might be on the safe side as it shows you a nice little notification whenever it detects that `node_modules` are out of date. But not everyone uses Webstorm. (Personally big VSCode fan but currently kinda jumping back and forth between the two).

So Emma just tweeted this which reminded me about a script that our current project is using.

{{< twitter 1298916262559576065 >}}

## The Strategy

The strategy is basically to check whether the `package.json` changed between the **current** and **previous Git head**.

This could be expressed with the following git command

```
$ git diff-tree -r --name-only --no-commit-id <previous-head> <current-head>
```

As an example. If I jump from my `main` branch (or `master`) to my `my-cool-feature` branch, I could execute

```
$ git diff-tree -r --name-only --no-commit-id main HEAD
.gitlab-ci.yml
angular.json
apps/myapp/myapp-e2e/src/app.e2e-spec.ts
apps/myapp/myapp-e2e/src/stackblitz.e2e-spec.ts
apps/myapp/myapp-e2e/tsconfig.json
libs/myapp/util/src/lib/stackblitz/stackblitz-filelist.ts
libs/myapp/util/src/lib/stackblitz/stackblitz-writer.ts
nx.json
package-lock.json
package.json
```

As you can see we get a list of files which we can now parse for the appearance of `package.json`.

## Implementing the script

So let's implement this as a Node.js script.



## Installing the script as a Git Hook



---

```javascript
#!/usr/bin/env node
const shell = require('shelljs');
const colors = require('colors');
const fs = require('fs');

const [
  NODE_PATH,
  SCRIPT_PATH,
  PREVIOUS_HEAD,
  CURRENT_HEAD,
  ISBRANCH,
] = process.argv;

let changedFiles = shell.exec(
  'git diff-tree -r --name-only --no-commit-id ' +
    PREVIOUS_HEAD +
    ' ' +
    CURRENT_HEAD
);

if (changedFiles.includes('package.json')) {
  let msg = 'package.json changed: ';
  if (fs.existsSync('yarn.lock')) {
    msg += 'Please run "yarn install"';
  } else {
    msg += 'Please run "npm install"';
  }

  let width = 80;
  console.log(
    colors.bold.inverse.yellow(
      [
        '='.repeat(width),
        ' '.repeat(width),
        msg.padStart(msg.length + (width - msg.length) / 2).padEnd(width, ' '),
        ' '.repeat(width),
        '='.repeat(width),
      ].join('\n')
    )
  );
}
```